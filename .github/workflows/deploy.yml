name: Build, Push & Deploy

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v2
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push backend image
              uses: docker/build-push-action@v4
              with:
                  context: ./backend
                  file: ./backend/Dockerfile
                  push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
                  tags: |
                      ghcr.io/${{ github.repository_owner }}/money-backend:latest
                      ghcr.io/${{ github.repository_owner }}/money-backend:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Build and push frontend image
              uses: docker/build-push-action@v4
              with:
                  context: ./frontend
                  file: ./frontend/Dockerfile
                  push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
                  tags: |
                      ghcr.io/${{ github.repository_owner }}/money-frontend:latest
                      ghcr.io/${{ github.repository_owner }}/money-frontend:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    deploy:
        runs-on: ubuntu-latest
        needs: build
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Deploy to VPS
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.DEPLOY_HOST }}
                  username: ${{ secrets.DEPLOY_USER }}
                  key: ${{ secrets.DEPLOY_KEY }}
                  script: |
                      cd /root/money
                      git pull origin main

                      # Update docker-compose to use pre-built images
                      cat > docker-compose.override.yml << 'EOF'
                      version: '3.8'
                      services:
                        backend:
                          image: ghcr.io/${{ github.repository_owner }}/money-backend:latest
                        frontend:
                          image: ghcr.io/${{ github.repository_owner }}/money-frontend:latest
                      EOF

                      # Login to GHCR
                      echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

                      # Pull latest images
                      docker pull ghcr.io/${{ github.repository_owner }}/money-backend:latest
                      docker pull ghcr.io/${{ github.repository_owner }}/money-frontend:latest

                      # Stop and remove old containers
                      docker-compose down

                      # Start with pre-built images
                      docker-compose -f docker-compose.yml -f docker-compose.override.yml up -d

                      # Run migrations
                      docker-compose exec -T backend npm run prisma:deploy || true

                      echo "✅ Deployment completed successfully!"

            - name: Notify on Success
              if: success()
              run: echo "✅ Deployment successful!"

            - name: Notify on Failure
              if: failure()
              run: echo "❌ Deployment failed!"
