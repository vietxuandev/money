name: Build, Push & Deploy

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v2
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push backend image
              uses: docker/build-push-action@v4
              with:
                  context: ./backend
                  file: ./backend/Dockerfile
                  push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
                  tags: |
                      ghcr.io/${{ github.repository_owner }}/money-backend:latest
                      ghcr.io/${{ github.repository_owner }}/money-backend:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Build and push frontend image
              uses: docker/build-push-action@v4
              with:
                  context: ./frontend
                  file: ./frontend/Dockerfile
                  push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
                  tags: |
                      ghcr.io/${{ github.repository_owner }}/money-frontend:latest
                      ghcr.io/${{ github.repository_owner }}/money-frontend:${{ github.sha }}
                  build-args: |
                      VITE_GRAPHQL_URL=${{ secrets.VITE_GRAPHQL_URL }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    deploy:
        runs-on: ubuntu-latest
        needs: build
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        steps:
            - name: Deploy to VPS
              uses: appleboy/ssh-action@v0.1.10
              with:
                  host: ${{ secrets.DEPLOY_HOST }}
                  username: ${{ secrets.DEPLOY_USER }}
                  key: ${{ secrets.DEPLOY_KEY }}
                  script: |
                      cd /root/money

                      # Login to GHCR
                      echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

                      # Pull latest images
                      docker compose pull backend frontend

                      # Restart services with new images
                      docker compose up -d --no-deps backend frontend

                      # Wait for containers to start
                      echo "Waiting for containers to start..."
                      sleep 10

                      # Show container status
                      echo "=== Container Status ==="
                      docker compose ps

                      # Show backend logs
                      echo "=== Backend Logs (last 100 lines) ==="
                      docker compose logs --tail=100 backend

                      # Wait for backend to be healthy
                      echo "=== Checking backend health ==="
                      for i in {1..30}; do
                        if docker compose exec -T backend wget --no-verbose --tries=1 --spider http://localhost:4000/graphql 2>/dev/null; then
                          echo "✅ Backend is healthy!"
                          break
                        fi
                        if [ $i -eq 30 ]; then
                          echo "❌ Backend failed to become healthy after 60 seconds"
                          echo "=== Final Backend Logs ==="
                          docker compose logs --tail=200 backend
                          exit 1
                        fi
                        echo "Attempt $i/30: Backend not ready yet..."
                        sleep 2
                      done

                      echo "✅ Deployment completed successfully!"

            - name: Notify on Success
              if: success()
              run: echo "✅ Deployment successful!"

            - name: Notify on Failure
              if: failure()
              run: echo "❌ Deployment failed!"
